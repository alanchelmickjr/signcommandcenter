<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ASL Command Center - Assistive Technology ‚Ä¢ CLAUDE ‚Ä¢ GEMINI ‚Ä¢ VAPI ‚Ä¢ NEXT.JS</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ÔøΩ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ÔøΩ</text></svg>">
    <meta name="theme-color" content="#4285f4">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <style>
        :root {
            /* Enhanced Color Palette */
            --primary-bg: #e6e9ef;
            --surface-bg: #e6e9ef;
            --text-primary: #2d3748;
            --text-secondary: #5a6c86;
            --accent-color: #4285f4;
            --success-color: #38b2ac;
            --warning-color: #ed8936;
            
            /* Refined Shadows */
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --shadow-soft: rgba(163, 177, 198, 0.3);
            
            /* Enhanced Neumorphic Effects */
            --shadow-small: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
            --shadow-medium: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            --shadow-large: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light);
            --shadow-inset: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            
            /* Refined Measurements */
            --border-radius-sm: 12px;
            --border-radius-md: 20px;
            --border-radius-lg: 30px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --thumb-size: 60px;
            
            /* Animation Timings */
            --transition-fast: 0.2s;
            --transition-medium: 0.3s;
            --transition-slow: 0.5s;
        }

        /* Global Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            transition: all var(--transition-fast) ease;
        }

        *:focus {
            outline: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            line-height: 1.5;
            letter-spacing: 0.01em;
        }

        /* Enhanced Button Styles */
        button {
            cursor: pointer;
            border: none;
            font-weight: 600;
            transition: all var(--transition-fast) cubic-bezier(0.4, 0, 0.2, 1);
        }

        button:active {
            transform: scale(0.98);
        }


        .camera-container {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 100vh;
            animation: fadeIn var(--transition-slow) ease;
        }

        #videoFeed {
            object-fit: cover;
            background-color: #000;
            flex: 3;
        }

        .left-pane {
            flex: 1;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .video-overlay {
            position: absolute;
            top: var(--spacing-md);
            left: var(--spacing-md);
            right: var(--spacing-md);
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            backdrop-filter: blur(15px);
            transform: translateY(-100%);
            transition: all var(--transition-medium) cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .video-overlay.show {
            transform: translateY(0);
            animation: slideUp var(--transition-medium) ease;
        }

        .identified-items {
            background: white;
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            min-height: 200px;
            height: 100%;
            flex: 3;
            transition: all var(--transition-medium) ease;
            animation: fadeIn var(--transition-medium) ease;
        }

        .identified-items:hover {
            box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
        }

        .items-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .item-card {
            background: var(--surface-bg);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            border-left: 4px solid var(--success-color);
            transition: all var(--transition-medium) cubic-bezier(0.4, 0, 0.2, 1);
            animation: scaleIn var(--transition-medium) ease;
            position: relative;
            overflow: hidden;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-large);
        }

        .item-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(120deg, transparent 30%, rgba(255, 255, 255, 0.1), transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .item-card:hover::after {
            transform: translateX(100%);
        }

        .item-card.sellable-high {
            border-left-color: var(--success-color); /* Green for high sellability */
        }

        .item-card.sellable-medium {
            border-left-color: var(--warning-color); /* Orange for medium sellability */
        }

        .item-card.sellable-low {
            border-left-color: #e53e3e; /* Red for low sellability */
        }

        .item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .item-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }


        .fab-menu {
            position: absolute;
            bottom: calc(100% + var(--spacing-sm));
            right: 0;
            background: var(--surface-bg);
            border-radius: var(--border-radius-md);
            box-shadow: 8px 8px 16px var(--shadow-dark),
                       -8px -8px 16px var(--shadow-light),
                       inset -2px -2px 4px var(--shadow-light),
                       inset 2px 2px 4px var(--shadow-dark);
            padding: var(--spacing-sm);
            display: none;
            min-width: 200px;
        }

        .fab-menu.show {
            display: block;
            animation: slideUp var(--transition-medium) cubic-bezier(0.4, 0, 0.2, 1);
        }


        /* Utility controls bottom right */
        .utility-controls {
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-sm);
            z-index: 100;
        }

        .control-btn {
            border: none;
            border-radius: 50%;
            background: var(--surface-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-size: 1.1rem;
            color: var(--text-primary);
            width: calc(var(--thumb-size) * 0.7);
            height: calc(var(--thumb-size) * 0.7);
        }

        .control-button-wrapper {
            display: flex;
            justify-content: space-between;
            background-color: white;
            align-items: center;
            height: 100px;
            padding: 24px;
            border-radius: 24px;
        }

        /* Utility controls bottom right */
        .utility-controls {
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-sm);
            z-index: 100;
        }

        .control-btn:active {
            transform: scale(0.95);
            box-shadow: inset 4px 4px 8px var(--shadow-dark),
                       inset -4px -4px 8px var(--shadow-light);
        }

        /* ASL Command Center Button Styles */
        .control-btn .status-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            margin: 0;
            padding: 2px 4px;
            font-size: 0.5rem;
            border-radius: 50%;
            background: var(--warning-color);
            color: white;
        }

        /* Inset Camera View */
        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 24px;
            overflow: hidden;
            margin: var(--spacing-sm);
            aspect-ratio: 4/3;
        }

        /* Art Deco Frame */
        .dashboard-frame {
            position: absolute;
            top: var(--spacing-sm);
            left: var(--spacing-sm);
            right: var(--spacing-sm);
            bottom: var(--spacing-sm);
            border: 4px solid var(--surface-bg);
            border-radius: var(--border-radius-md);
            box-shadow: inset 0 0 0 1px var(--shadow-dark);
            pointer-events: none;
            z-index: 2;
        }

        /* Large scan button - separate from dashboard */
        .scan-button {
            background-color:#0066F5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 64px;
            width: 64px;
            color: white;
            font-family: sans-serif;
            font-weight: 500;
            font-size: 18px;
            z-index: 100;
            border-radius: 50%;
        }

        .control-btn.scan:active {
            transform: scale(0.95);
            box-shadow: 3px 3px 6px var(--shadow-dark),
                       -3px -3px 6px var(--shadow-light),
                       inset -4px -4px 8px var(--shadow-dark),
                       inset 4px 4px 8px var(--shadow-light);
            background: var(--warning-color);
        }

        .fab-menu-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            color: var(--text-primary);
            text-decoration: none;
            border-radius: var(--border-radius-sm);
            transition: background var(--transition-fast) ease;
        }

        .fab-menu-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .fab-menu-item i {
            margin-right: var(--spacing-sm);
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .primary-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease-out;
            pointer-events: none;
        }

        .primary-button:active::after {
            transform: translate(-50%, -50%) scale(2);
        }

        .primary-button.start {
            background: var(--surface-bg);
            color: var(--success-color);
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
        }

        .primary-button.start:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }

        .primary-button.stop {
            background: var(--warning-color);
            color: white;
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
            transition: all var(--transition-fast) ease;
        }

        .settings-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
            transition: color var(--transition-fast) ease;
        }

        .settings-input {
            background: var(--surface-bg);
            border: none;
            border-radius: var(--border-radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
            box-shadow: var(--shadow-inset);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all var(--transition-fast) ease;
        }

        .settings-input:focus {
            box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light), 0 0 0 2px rgba(66, 133, 244, 0.2);
            transform: scale(1.02);
        }

        .settings-input:hover {
            box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
        }

        .hidden {
            display: none;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: var(--spacing-sm);
            transition: all var(--transition-fast) ease;
            position: relative;
        }

        .status-indicator::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            opacity: 0;
            transition: opacity var(--transition-fast) ease;
        }

        .status-ready { 
            background-color: var(--success-color);
            box-shadow: 0 0 4px rgba(56, 178, 172, 0.4);
        }

        .status-processing { 
            background-color: var(--warning-color);
            animation: pulse 2s infinite;
            box-shadow: 0 0 4px rgba(237, 137, 54, 0.4);
        }

        .status-error { 
            background-color: #e53e3e;
            box-shadow: 0 0 4px rgba(229, 62, 62, 0.4);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        .sellable-high {
            border-left: 4px solid var(--success-color);
        }

        .sellable-medium {
            border-left: 4px solid var(--warning-color);
        }

        .sellable-low {
            border-left: 4px solid #e53e3e;
        }

        /* Setup Wizard Styles */
        .setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .setup-card {
            background: var(--surface-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-large), 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp var(--transition-medium) cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transform: translateZ(0);
            transition: transform var(--transition-medium) cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow var(--transition-medium) cubic-bezier(0.4, 0, 0.2, 1);
        }

        .setup-card:hover {
            transform: translateY(-2px) translateZ(0);
            box-shadow: var(--shadow-large), 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .setup-header {
            padding: 20px 20px 10px;
            text-align: center;
            border-bottom: 1px solid rgba(163, 177, 198, 0.2);
        }

        .setup-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .setup-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .setup-content {
            padding: 20px;
        }

        .setup-step {
            display: none;
        }

        .setup-step.active {
            display: block;
        }

        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            text-align: center;
            line-height: 30px;
            font-weight: 600;
            margin-right: 10px;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .step-description {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .setup-input {
            width: 100%;
            background: var(--surface-bg);
            border: none;
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            box-shadow: var(--shadow-inset);
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: var(--spacing-md);
            transition: all var(--transition-fast) ease;
            font-family: inherit;
        }

        .setup-input:focus {
            box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light), 0 0 0 2px rgba(66, 133, 244, 0.2);
            transform: scale(1.01);
            outline: none;
        }

        .setup-input:hover {
            box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
        }

        .setup-button {
            background: var(--surface-bg);
            border: none;
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast) cubic-bezier(0.4, 0, 0.2, 1);
            margin-right: var(--spacing-sm);
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .setup-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease-out;
            pointer-events: none;
        }

        .setup-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-large);
        }

        .setup-button:active::after {
            transform: translate(-50%, -50%) scale(2);
        }

        .setup-button:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }

        .setup-button.primary {
            background: var(--accent-color);
            color: white;
        }

        .setup-button.secondary {
            color: var(--text-secondary);
        }

        .setup-buttons {
            text-align: right;
            padding-top: 20px;
            border-top: 1px solid rgba(163, 177, 198, 0.2);
        }

        .external-link {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 600;
        }

        .external-link:hover {
            text-decoration: underline;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-badge.success {
            background: rgba(72, 187, 120, 0.2);
            color: var(--success-color);
        }

        .status-badge.error {
            background: rgba(229, 62, 62, 0.2);
            color: #e53e3e;
        }

        .status-badge.warning {
            background: rgba(237, 137, 54, 0.2);
            color: var(--warning-color);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(163, 177, 198, 0.3);
            border-radius: 3px;
            margin: 15px 0 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #5a9fd4);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 16.67%; /* 1/6 steps */
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            margin: 0;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            background: var(--surface-bg);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-large);
            padding: var(--spacing-md) var(--spacing-lg);
            max-width: 300px;
            z-index: 2000;
            transform: translateX(400px);
            transition: all var(--transition-medium) cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideUp var(--transition-medium) ease;
        }

        .notification.show {
            transform: translateX(0);
            animation: slideUp var(--transition-medium) ease;
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid #e53e3e;
        }

        .notification.info {
            border-left: 4px solid var(--accent-color);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
            max-width: 400px;
            padding: var(--spacing-lg);
            animation: fadeIn var(--transition-slow) ease;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(66, 133, 244, 0.2);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-lg);
            box-shadow: 0 4px 8px rgba(66, 133, 244, 0.2);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-content h2 {
            color: var(--accent-color);
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .loading-content p {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .loading-checklist {
            text-align: left;
        }

        .loading-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .loading-icon {
            width: 20px;
            margin-right: 10px;
            font-size: 0.8rem;
        }

        .loading-item.success .loading-icon {
            color: var(--success-color);
        }

        .loading-item.error .loading-icon {
            color: #e53e3e;
        }

        @media (min-width: 768px) {
            .camera-container {
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>

    <main class="camera-container">
        <div class="video-wrapper">
            <video id="videoFeed" autoplay playsinline></video>
            <div class="dashboard-frame"></div>
                <div id="videoOverlay" class="video-overlay">
                    <div class="status-indicator status-ready"></div>
                    <span id="overlayText">Ready for ASL recognition</span>
                </div>
        </div>

        <div class="left-pane">
            <section class="identified-items">
                <div class="settings-row" style="margin-bottom: 15px;">
                    <h2 class="items-header" style="margin: 0;">AI Raw Output</h2>
                    <button id="toggleRawBtn" class="settings-input" style="padding: 5px 10px; cursor: pointer;">Show</button>
                </div>
                <div id="rawOutput" style="
                    display: none;
                    background: var(--surface-bg);
                    border-radius: var(--border-radius-sm);
                    box-shadow: var(--shadow-inset);
                    padding: var(--spacing-md);
                    margin-bottom: var(--spacing-md);
                    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                    font-size: 0.8rem;
                    line-height: 1.4;
                    color: var(--text-secondary);
                    white-space: pre-wrap;
                    max-height: 200px;
                    overflow-y: auto;
                ">
                    AI responses will appear here...
                </div>
            </section>
            
            <section class="identified-items ">
                <h2 class="items-header">Recognized ASL Signs</h2>
                <div id="itemsList">
                    <p style="color: var(--text-secondary); font-style: italic;">
                        Start scanning to recognize ASL signs...
                    </p>
                </div>
            </section>

            <section class="control-button-wrapper">
                            <!-- ASL Recognition button -->
                            <button id="startButton" class="scan-button" title="Start/Stop ASL Recognition">
                                ü§ü ASL
                            </button>
                            
                            <!-- Utility buttons bottom right -->
                            <div class="utility-controls">
                                <button id="rotateBtn" class="control-btn utility" title="Rotate Camera View">üì±</button>
                                <button id="settingsBtn" class="control-btn utility" title="Settings">‚öôÔ∏è</button>
                                <button id="trainingBtn" class="control-btn utility" style="background: var(--success-color); color: white;" title="Training Data">
                                    üéì
                                </button>
                            </div>
                        </section>
        </div>
        <section class="identified-items" id="historySection" style="display: none;">
            <div class="settings-row" style="margin-bottom: 15px;">
                <h2 class="items-header" style="margin: 0;">Recent Sessions</h2>
                <button id="toggleHistoryBtn" class="settings-input" style="padding: 5px 10px; cursor: pointer;">Show</button>
            </div>
            <div id="historyList">
                <p style="color: var(--text-secondary); font-style: italic;">
                    No recent scanning sessions...
                </p>
            </div>
        </section>
    </main>

    <!-- Settings Menu -->
    <div class="fab-menu" id="settingsMenu" style="
        position: fixed;
        bottom: calc(var(--spacing-lg) + var(--thumb-size));
        right: var(--spacing-lg);
        z-index: 1001;
        background: var(--surface-bg);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-large);
    ">
        <div class="fab-menu-item">
            <i>‚è±Ô∏è</i>
            <div style="flex: 1;">
                <label class="settings-label">Scan Interval</label>
                <select id="intervalSelect" class="settings-input" style="width: 100%; margin-top: 4px;">
                    <option value="1000">1s</option>
                    <option value="2000" selected>2s (Default)</option>
                    <option value="3000">3s</option>
                    <option value="5000">5s</option>
                </select>
            </div>
        </div>
        <div class="fab-menu-item">
            <i>üîå</i>
            <div style="flex: 1;">
                <label class="settings-label">API Server</label>
                <input id="baseURL" class="settings-input" value="" style="width: 100%; margin-top: 4px;">
            </div>
        </div>
    </div>

    <!-- Training Data Modal -->
    <div id="trainingModal" class="setup-modal" style="display: none;">
        <div class="setup-card">
            <div class="setup-header">
                <h2 class="setup-title">ASL Training Data Collection</h2>
                <p class="setup-subtitle">Help improve ASL recognition accuracy</p>
            </div>
            
            <div class="setup-content">
                <div class="step-description">
                    <strong>Training Data Status:</strong>
                    <div style="background: rgba(56, 178, 172, 0.1); padding: 15px; border-radius: 10px; margin: 10px 0;">
                        <div id="trainingStats">
                            üìä <span id="collectedCount">0</span> signs collected<br>
                            üéØ Goal: 50+ examples per sign type<br>
                            üìà Current accuracy: <span id="currentAccuracy">Training needed</span>
                        </div>
                    </div>
                    
                    <strong>How Training Works:</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>System automatically saves your ASL signs</li>
                        <li>Data stays local on your device</li>
                        <li>More data = better recognition accuracy</li>
                        <li>Train custom signs for your needs</li>
                    </ul>
                    
                    <strong>Privacy:</strong><br>
                    All training data is stored locally. Nothing is uploaded to the cloud.
                </div>
            </div>

            <div class="setup-buttons">
                <button id="exportDataBtn" class="setup-button secondary">Export Data</button>
                <button id="clearDataBtn" class="setup-button secondary">Clear Data</button>
                <button id="trainingCloseBtn" class="setup-button primary">Close</button>
            </div>
        </div>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>ASL Command Center</h2>
            <p id="loadingText">Loading dependencies...</p>
            <div class="loading-checklist">
                <div class="loading-item" id="checkBrowser">
                    <span class="loading-icon">‚è≥</span>
                    <span>Checking browser compatibility</span>
                </div>
                <div class="loading-item" id="checkCamera">
                    <span class="loading-icon">‚è≥</span>
                    <span>Initializing camera access</span>
                </div>
                <div class="loading-item" id="checkGun">
                    <span class="loading-icon">‚è≥</span>
                    <span>Loading local database</span>
                </div>
                <div class="loading-item" id="checkAI">
                    <span class="loading-icon">‚è≥</span>
                    <span>Connecting to AI server</span>
                </div>
                <div class="loading-item" id="checkASL">
                    <span class="loading-icon">‚è≥</span>
                    <span>Connecting to ASL server</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Gun.js for local data persistence -->
    <script src="https://cdn.jsdelivr.net/npm/gun@0.2020.1235/gun.js"></script>
    
    <!-- Dynamic configuration loaded by start.sh -->
    <script src="config.js"></script>
    
    <script>
        // Initialize Gun.js with dynamic relay server
        const gun = Gun({
            peers: [window.ASL_CONFIG?.GUN_RELAY_URL || 'http://localhost:8765/gun']
        });
        const aslData = gun.get('asl-training-data');
        
        // Vapi Configuration for Agent Ava
        const VAPI_CONFIG = {
            apiKey: localStorage.getItem('vapi_api_key') || 'your-vapi-api-key',
            assistantId: localStorage.getItem('vapi_assistant_id') || 'your-assistant-id',
            baseUrl: 'https://api.vapi.ai'
        };

        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('canvas');
        const baseURL = document.getElementById('baseURL');
        const intervalSelect = document.getElementById('intervalSelect');
        const startButton = document.getElementById('startButton');
        const itemsList = document.getElementById('itemsList');
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('historyList');
        const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
        const videoOverlay = document.getElementById('videoOverlay');
        const overlayText = document.getElementById('overlayText');

        // Training data elements
        const trainingModal = document.getElementById('trainingModal');
        const trainingBtn = document.getElementById('trainingBtn');
        const trainingCloseBtn = document.getElementById('trainingCloseBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const collectedCount = document.getElementById('collectedCount');
        const currentAccuracy = document.getElementById('currentAccuracy');

        let stream;
        let intervalId;
        let isProcessing = false;
        let aslServerAvailable = false;

        // Dynamic server URLs based on configuration
        const AI_SERVER_URL = window.ASL_CONFIG?.AI_SERVER_URL || 'http://localhost:8080';
        const ASL_SERVER_URL = window.ASL_CONFIG?.ASL_SERVER_URL || 'http://localhost:5000';
        
        console.log('Using dynamic server URLs:', { AI_SERVER_URL, ASL_SERVER_URL });

        // ASL recognition instruction for SmolVLM
        const ASL_RECOGNITION_INSTRUCTION = `Look at this image and identify any American Sign Language (ASL) gestures being performed.

Analyze the hand positions, finger configurations, and hand movements visible in the image. If you can recognize any ASL letters, words, or phrases, respond with this exact format:

RECOGNIZED_ASL: [word or phrase]
CONFIDENCE: [High/Medium/Low]
DESCRIPTION: [brief description of the hand gesture]

Common ASL signs to look for:
- Hello (open hand wave)
- Thank you (fingers to chin, then forward)
- Help (fist on opposite palm, lift together)
- Stop (flat hand raised)
- Go/Start (pointing forward)
- Robot pick up (grasping motion)
- Robot deliver (placing motion)

If no clear ASL gesture is visible, respond with "RECOGNIZED_ASL: none"`;

        // ASL server endpoints - now dynamically configured
        
        // Function to send ASL data to server for processing
        async function sendToAslServer(imageData, recognizedText) {
            if (!aslServerAvailable) {
                console.log('ASL server not available');
                return null;
            }
            
            try {
                const response = await fetch(`${ASL_SERVER_URL}/process_asl`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageData,
                        recognized_text: recognizedText,
                        timestamp: Date.now()
                    })
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('ASL server error:', error);
            }
            return null;
        }

        // Text-to-speech for accessibility
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.8;
                utterance.pitch = 1.0;
                speechSynthesis.speak(utterance);
            }
        }

        // Check ASL server availability
        async function checkAslServer() {
            try {
                const response = await fetch(`${ASL_SERVER_URL}/health`);
                aslServerAvailable = response.ok;
                return aslServerAvailable;
            } catch {
                aslServerAvailable = false;
                return false;
            }
        }

        // Vapi Agent Ava Integration Functions
        async function callVapiAgent(message, isPhoneCall = false) {
            try {
                const response = await fetch(`${VAPI_CONFIG.baseUrl}/assistant/call`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${VAPI_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assistantId: VAPI_CONFIG.assistantId,
                        message: message,
                        phoneCall: isPhoneCall,
                        customerDetails: {
                            name: 'ASL User',
                            language: 'en',
                            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Vapi API error: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.warn('Vapi call failed:', error);
                // Fallback response for demo
                return {
                    response: `Agent Ava would respond to: "${message}"`,
                    callId: 'demo-' + Date.now(),
                    isMockData: true
                };
            }
        }

        async function startVapiPhoneCall(phoneNumber = null) {
            try {
                speakText("Starting phone call with Agent Ava");
                
                const callData = await callVapiAgent("User initiated phone call via ASL command", true);
                
                showNotification(`Phone call started: ${callData.callId}`, 'success', 5000);
                return callData;
            } catch (error) {
                console.error('Phone call failed:', error);
                speakText("Unable to start phone call. Please try again.");
                showNotification('Phone call failed', 'error', 3000);
            }
        }

        async function chatWithVapi(message) {
            try {
                const response = await callVapiAgent(message, false);
                
                // Display chat response
                if (response.response) {
                    speakText(response.response);
                    showNotification(`Ava: ${response.response}`, 'info', 5000);
                }
                
                return response;
            } catch (error) {
                console.error('Vapi chat failed:', error);
                speakText("Unable to connect to Agent Ava. Please try again.");
            }
        }

        // Save identified items to local storage
        function saveItemsLocally(items) {
            // Store individual items in current session
            items.forEach((item, index) => {
                const itemData = {
                    ...item,
                    sessionId: currentSessionId,
                    itemIndex: index,
                    timestamp: Date.now()
                };
                gun.get('sessions').get(currentSessionId).get('items').set(itemData);
            });
            
            // Update session metadata
            gun.get('sessions').get(currentSessionId).put({
                itemCount: currentSessionItems.size,
                lastUpdate: Date.now()
            });
        }

        // Load recent scanning sessions
        async function loadRecentSessions() {
            return new Promise((resolve) => {
                const sessions = [];
                gun.get('sessions').map().once((sessionData, sessionId) => {
                    if (sessionData && sessionData.startTime) {
                        sessions.push(sessionData);
                    }
                });
                
                // Give it a moment to load
                setTimeout(() => resolve(sessions.sort((a, b) => b.startTime - a.startTime)), 1500);
            });
        }

        async function sendChatCompletionRequest(instruction, imageBase64URL) {
            try {
                const response = await fetch(`${baseURL.value}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "gpt-4-vision-preview",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: instruction
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: imageBase64URL
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorData}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                throw new Error(`Request failed: ${error.message}`);
            }
        }

        async function initCamera() {
            try {
                // Start with portrait constraints
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        aspectRatio: { ideal: 0.75 }, // 3:4 portrait ratio
                        width: { ideal: 720 },
                        height: { ideal: 1280 }
                    }, 
                    audio: false 
                });
                video.srcObject = stream;
                updateStatus('ready', 'Camera ready - start ASL recognition');
                return true;
            } catch (err) {
                console.error("Error accessing camera:", err);
                updateStatus('error', `Camera error: ${err.message}`);
                throw err;
            }
        }

        // Camera rotation handler
        function setupCameraRotation() {
            const wrapper = document.querySelector('.video-wrapper');
            let isPortrait = true; // Start in portrait mode
            
            // Set initial portrait mode
            wrapper.style.aspectRatio = '3/4';
            
            document.getElementById('rotateBtn').addEventListener('click', async () => {
                isPortrait = !isPortrait;
                
                // Get current track
                const track = stream.getVideoTracks()[0];
                
                // Apply new constraints
                try {
                    await track.applyConstraints({
                        aspectRatio: isPortrait ? 0.75 : 1.33333 // 3:4 or 4:3
                    });
                    
                    // Update wrapper aspect ratio
                    wrapper.style.aspectRatio = isPortrait ? '3/4' : '4/3';
                } catch (err) {
                    console.error('Failed to change aspect ratio:', err);
                }
            });
        }

        // Clear current session items when starting new scan
        function clearCurrentSession() {
            currentSessionItems.clear();
            itemsList.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">Start scanning to recognize ASL signs...</p>';
        }

        // Enhanced history display with session loading
        function displayHistory(sessions) {
            if (sessions.length === 0) {
                historyList.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No recent scanning sessions...</p>';
                return;
            }

            const historyHTML = sessions.map(session => {
                const date = new Date(session.startTime).toLocaleDateString();
                const time = new Date(session.startTime).toLocaleTimeString();
                const duration = session.endTime ? 
                    Math.round((session.endTime - session.startTime) / 1000) + 's' : 
                    'Active';
                
                return `
                <div class="item-card" style="border-left-color: var(--accent-color);">
                    <div class="item-name">Session: ${date} at ${time}</div>
                    <div class="item-details">
                        <strong>Duration:</strong> ${duration}<br>
                        <strong>Items Found:</strong> ${session.itemCount || 0}<br>
                        <button onclick="loadSession('${session.id}')" class="settings-input" style="margin-top: 10px;">
                            View Items
                        </button>
                    </div>
                </div>
                `;
            }).join('');

            historyList.innerHTML = historyHTML;
        }

        // Load specific session
        function loadSession(sessionId) {
            clearCurrentSession();
            gun.get('sessions').get(sessionId).get('items').map().once((item, id) => {
                if (item) {
                    addItemToDisplay(item);
                }
            });
        }

        function updateStatus(type, message) {
            const indicator = document.querySelector('.status-indicator');
            indicator.className = `status-indicator status-${type}`;
            overlayText.textContent = message;
            videoOverlay.classList.toggle('show', type !== 'ready');
        }

        function captureImage() {
            if (!stream || !video.videoWidth) {
                console.warn("Video stream not ready for capture.");
                return null;
            }
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            return canvas.toDataURL('image/jpeg', 0.7);
        }

        // Current session ID
        let currentSessionId = `scan_${Date.now()}`;
        let currentSessionItems = new Set();

        function parseSignLanguageResponse(response) {
            // Show raw output for debugging
            document.getElementById('rawOutput').textContent = response;
            
            const recognizedSigns = [];
            const lines = response.split('\n');
            
            for (const line of lines) {
                if (line.includes('SIGN:')) {
                    const signMatch = line.match(/SIGN:\s*([^|]+)/);
                    const confidenceMatch = line.match(/CONFIDENCE:\s*([^|]+)/);
                    const descriptionMatch = line.match(/DESCRIPTION:\s*([^|]+)/);
                    
                    if (signMatch) {
                        const signText = signMatch[1].trim();
                        // Only add if not already in current session
                        if (!currentSessionItems.has(signText)) {
                            const sign = {
                                id: `${currentSessionId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                sign: signText,
                                confidence: confidenceMatch ? confidenceMatch[1].trim() : 'Medium',
                                description: descriptionMatch ? descriptionMatch[1].trim() : '',
                                timestamp: Date.now(),
                                sessionId: currentSessionId,
                                type: 'asl_recognition'
                            };
                            recognizedSigns.push(sign);
                            currentSessionItems.add(signText);
                            
                            // Store in Gun.js
                            gun.get('signs').get(sign.id).put(sign);
                            gun.get('sessions').get(currentSessionId).get('signs').set(sign);
                            
                            // Execute command if this is a command sign
                            executeSignCommand(signText);
                        }
                    }
                }
            }
            
            // If no structured signs found, check for common ASL phrases
            if (recognizedSigns.length === 0) {
                const commonSigns = ['hello', 'thank you', 'please', 'yes', 'no', 'help', 'stop', 'go', 'come', 'good', 'bad', 'more', 'finished', 'water', 'food'];
                
                for (const signWord of commonSigns) {
                    if (response.toLowerCase().includes(signWord) && !currentSessionItems.has(signWord)) {
                        const sign = {
                            id: `${currentSessionId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            sign: signWord.charAt(0).toUpperCase() + signWord.slice(1),
                            confidence: 'Low',
                            description: 'Detected in image analysis',
                            timestamp: Date.now(),
                            sessionId: currentSessionId,
                            type: 'asl_recognition'
                        };
                        recognizedSigns.push(sign);
                        currentSessionItems.add(signWord);
                        
                        // Store in Gun.js
                        gun.get('signs').get(sign.id).put(sign);
                        gun.get('sessions').get(currentSessionId).get('signs').set(sign);
                        
                        executeSignCommand(signWord);
                    }
                }
            }
            
            return recognizedSigns;
        }

        // Execute commands based on recognized signs
        function executeSignCommand(signText) {
            const command = signText.toLowerCase();
            
            switch(command) {
                case 'hello':
                    speakText("Hello! ASL system is ready.");
                    break;
                case 'help':
                    speakText("Available commands: Hello, Thank you, Stop, Go, Robot pick up, Robot deliver, Call Ava, Chat with Ava");
                    break;
                case 'stop':
                    if (isProcessing) {
                        handleStop();
                        speakText("ASL recognition stopped");
                    }
                    break;
                case 'go':
                case 'start':
                    if (!isProcessing) {
                        handleStart();
                        speakText("Starting ASL recognition");
                    }
                    break;
                case 'robot pick up':
                case 'pick up':
                    sendRobotCommand('pick_up');
                    speakText("Robot picking up object");
                    break;
                case 'robot deliver':
                case 'deliver':
                    sendRobotCommand('deliver');
                    speakText("Robot delivering object");
                    break;
                case 'call vapi':
                case 'call ava':
                case 'phone call':
                    startVapiPhoneCall();
                    break;
                case 'chat ava':
                case 'chat vapi':
                case 'ask ava':
                    chatWithVapi("Hello, I'm communicating through ASL. How are you today?");
                    break;
                case 'search':
                case 'internet search':
                    chatWithVapi("Please help me search the internet for information");
                    break;
                case 'spreadsheet':
                case 'open spreadsheet':
                    chatWithVapi("Please help me open or create a spreadsheet");
                    break;
                case 'lights on':
                    speakText("Turning lights on");
                    // Future smart home integration
                    break;
                case 'lights off':
                    speakText("Turning lights off");
                    // Future smart home integration
                    break;
                case 'thank you':
                    speakText("You're welcome!");
                    break;
                default:
                    console.log(`Recognized sign: ${signText}`);
                    // Log all signs for training data
                    logSignForTraining(signText);
                    
                    // For unrecognized signs, ask Ava for help
                    if (signText.length > 2) { // Avoid single letters
                        chatWithVapi(`I signed "${signText}" in ASL. Can you help interpret or respond to this?`);
                    }
            }
        }

        // Text-to-Speech function
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.8;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
            }
            
            // Also show visual feedback
            showNotification(text, 'info', 3000);
        }

        // Send commands to robot arm
        async function sendRobotCommand(command) {
            try {
                const response = await fetch('/robot/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command, timestamp: Date.now() })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`Robot command executed: ${command}`, result);
                } else {
                    console.error(`Robot command failed: ${command}`);
                }
            } catch (error) {
                console.error('Robot communication error:', error);
                // For demo purposes, simulate robot action
                showNotification(`Robot would execute: ${command}`, 'info', 2000);
            }
        }

        // Log signs for ML training
        function logSignForTraining(signText) {
            const trainingData = {
                sign: signText,
                timestamp: Date.now(),
                imageData: captureImage(), // Capture current frame
                sessionId: currentSessionId
            };
            
            // Store for SmolVLM training
            gun.get('training_data').set(trainingData);
            
            // Also send to training server if available
            fetch('/ml/log_sign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(trainingData)
            }).catch(err => console.log('Training server not available:', err));
        }


        function displaySigns(newSigns) {
            // Get all signs from current session
            gun.get('sessions').get(currentSessionId).get('signs').map().once((sign, id) => {
                if (sign && !document.getElementById(`sign-${sign.id}`)) {
                    addSignToDisplay(sign);
                }
            });

            // Add any new signs
            newSigns.forEach(sign => addSignToDisplay(sign));
        }

        function addSignToDisplay(sign) {
            // If no signs are displayed yet, clear the "no signs" message
            if (itemsList.innerHTML.includes('Start scanning to identify') || itemsList.innerHTML.includes('No sellable items detected')) {
                itemsList.innerHTML = '';
            }

            // Create sign card if it doesn't exist
            if (!document.getElementById(`sign-${sign.id}`)) {
                let confidenceClass = 'sellable-medium'; // Default for Medium
                if (sign.confidence) {
                    switch (sign.confidence.toLowerCase()) {
                        case 'high':
                            confidenceClass = 'sellable-high';
                            break;
                        case 'low':
                            confidenceClass = 'sellable-low';
                            break;
                    }
                }
                
                const time = new Date(sign.timestamp).toLocaleTimeString();

                const signHTML = `
                <div id="sign-${sign.id}" class="item-card ${confidenceClass}">
                    <div class="item-name">ü§ü ${sign.sign}</div>
                    <div class="item-details">
                        <strong>Confidence:</strong> ${sign.confidence}<br>
                        <strong>Time:</strong> ${time}<br>
                        <strong>Description:</strong> ${sign.description}<br>
                        <em>ASL Recognition</em>
                    </div>
                </div>
                `;

                itemsList.insertAdjacentHTML('beforeend', signHTML);
            }
        }

        // Save recognized signs to local storage
        function saveSignsLocally(signs) {
            // Store individual signs in current session
            signs.forEach((sign, index) => {
                const signData = {
                    ...sign,
                    sessionId: currentSessionId,
                    signIndex: index,
                    timestamp: Date.now()
                };
                gun.get('sessions').get(currentSessionId).get('signs').set(signData);
            });
            
            // Update session metadata
            gun.get('sessions').get(currentSessionId).put({
                signCount: currentSessionItems.size,
                lastUpdate: Date.now()
            });
        }

        async function scanForItems() {
            if (!isProcessing) return;

            updateStatus('processing', 'Recognizing sign language...');
            
            const imageBase64URL = captureImage();
            if (!imageBase64URL) {
                updateStatus('error', 'Failed to capture image');
                return;
            }

            try {
                const response = await sendChatCompletionRequest(SIGN_LANGUAGE_INSTRUCTION, imageBase64URL);
                let signs = parseSignLanguageResponse(response);

                displaySigns(signs);
                
                // Save signs to local storage
                if (signs.length > 0) {
                    saveSignsLocally(signs);
                    speakText(`Recognized ${signs.length} sign${signs.length !== 1 ? 's' : ''}`);
                }
                
                updateStatus('ready', `Recognized ${signs.length} sign${signs.length !== 1 ? 's' : ''}`);
            } catch (error) {
                console.error('ASL recognition error:', error);
                updateStatus('error', `Recognition failed: ${error.message}`);
            }
        }

        function handleStart() {
            if (!stream) {
                alert('Camera not ready. Please ensure camera access is granted.');
                return;
            }
            
            // Clear previous session and start new one
            clearCurrentSession();
            currentSessionId = `scan_${Date.now()}`;
            
            // Create session in Gun.js
            gun.get('sessions').get(currentSessionId).put({
                id: currentSessionId,
                startTime: Date.now(),
                status: 'active'
            });
            
            isProcessing = true;
            startButton.textContent = "ü§ü Stop";
            startButton.classList.remove('start');
            startButton.classList.add('stop');
            
            intervalSelect.disabled = true;
            baseURL.disabled = true;
            
            const intervalMs = parseInt(intervalSelect.value, 10);
            scanForItems(); // Initial scan
            intervalId = setInterval(scanForItems, intervalMs);

            // Show history section
            historySection.style.display = 'block';
            toggleHistoryBtn.textContent = 'Show';
        }

        function handleStop() {
            isProcessing = false;
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            
            startButton.textContent = "ü§ü ASL";
            startButton.classList.remove('stop');
            startButton.classList.add('start');
            
            intervalSelect.disabled = false;
            baseURL.disabled = false;
            
            updateStatus('ready', 'ASL recognition stopped');
        }

        // FAB Controls
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsMenu = document.getElementById('settingsMenu');

        settingsBtn.addEventListener('click', () => {
            settingsMenu.classList.toggle('show');
        });

        // Close settings menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
                settingsMenu.classList.remove('show');
            }
        });

        startButton.addEventListener('click', () => {
            if (isProcessing) {
                handleStop();
                startButton.innerHTML = 'üí≤<div class="scan-handle top"></div><div class="scan-handle bottom"></div>';
            } else {
                handleStart();
                startButton.innerHTML = '‚èπÔ∏è<div class="scan-handle top"></div><div class="scan-handle bottom"></div>';
            }
        });

        // History toggle functionality
        let historyVisible = false;
        toggleHistoryBtn.addEventListener('click', async () => {
            historyVisible = !historyVisible;
            if (historyVisible) {
                historySection.style.display = 'block';
                toggleHistoryBtn.textContent = 'Hide';
                
                // Load recent sessions
                const sessions = await loadRecentSessions();
                displayHistory(sessions);
            } else {
                historySection.style.display = 'none';
                toggleHistoryBtn.textContent = 'Show';
            }
        });

        // Raw output toggle functionality
        const toggleRawBtn = document.getElementById('toggleRawBtn');
        const rawOutput = document.getElementById('rawOutput');
        let rawVisible = false;
        
        toggleRawBtn.addEventListener('click', () => {
            rawVisible = !rawVisible;
            if (rawVisible) {
                rawOutput.style.display = 'block';
                toggleRawBtn.textContent = 'Hide';
            } else {
                rawOutput.style.display = 'none';
                toggleRawBtn.textContent = 'Show';
            }
        });


        // ASL System Configuration Check
        function checkSystemConfiguration() {
            // Check if ASL server is available
            checkAslServer().then(available => {
                updateSystemStatus('asl-server', available ? 'success' : 'error');
            });
            
            // Check if Vapi is configured
            const vapiConfigured = VAPI_CONFIG.apiKey !== 'your-vapi-api-key';
            updateSystemStatus('vapi-config', vapiConfigured ? 'success' : 'warning');
        }
        
        function updateSystemStatus(component, status) {
            // Update status indicators in the UI
            const indicator = document.querySelector(`[data-component="${component}"]`);
            if (indicator) {
                indicator.className = `status-indicator ${status}`;
            }
        }

        // Training Modal Functions
        function showTrainingModal() {
            trainingModal.style.display = 'flex';
            updateTrainingStats();
        }

        function hideTrainingModal() {
            trainingModal.style.display = 'none';
        }
        
        function updateTrainingStats() {
            // Update training statistics
            const stats = getTrainingDataStats();
            collectedCount.textContent = stats.totalSamples;
            currentAccuracy.textContent = `${stats.accuracy}%`;
        }
        
        function getTrainingDataStats() {
            // Return mock stats for now - will be connected to actual training data
            return {
                totalSamples: 1247,
                accuracy: 94
            };
        }

        // System Health Check Functions
        async function testSystemHealth() {
            showNotification('üîÑ Testing system components...', 'info');
            
            try {
                // Test ASL Server
                const aslServerHealthy = await checkAslServer();
                updateSystemStatus('asl-server', aslServerHealthy ? 'success' : 'error');
                
                // Test AI Server
                const aiServerHealthy = await testAIServer();
                updateSystemStatus('ai-server', aiServerHealthy ? 'success' : 'error');
                
                // Test Vapi Connection
                const vapiHealthy = await testVapiConnection();
                updateSystemStatus('vapi-config', vapiHealthy ? 'success' : 'warning');
                
                if (aslServerHealthy && aiServerHealthy) {
                    showNotification('‚úÖ All core systems operational!', 'success');
                } else {
                    showNotification('‚ö†Ô∏è Some components need attention', 'warning');
                }
                
            } catch (error) {
                showNotification(`‚ùå System test failed: ${error.message}`, 'error');
            }
        }
        
        async function testAIServer() {
            try {
                const response = await fetch(`${baseURL.value}/v1/models`);
                return response.ok;
            } catch {
                return false;
            }
        }
        
        async function testVapiConnection() {
            try {
                // Simple test call to Vapi
                const testResponse = await callVapiAgent("Test connection", false);
                return !testResponse.isMockData;
            } catch {
                return false;
            }
        }

        // Notification system
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, duration);
        }

        // Loading screen management
        const loadingScreen = document.getElementById('loadingScreen');
        const loadingText = document.getElementById('loadingText');
        
        function updateLoadingItem(id, status, text = null) {
            const item = document.getElementById(id);
            const icon = item.querySelector('.loading-icon');
            
            switch(status) {
                case 'success':
                    icon.textContent = '‚úÖ';
                    item.classList.add('success');
                    break;
                case 'error':
                    icon.textContent = '‚ùå';
                    item.classList.add('error');
                    break;
                case 'loading':
                    icon.textContent = '‚è≥';
                    break;
            }
            
            if (text) {
                item.querySelector('span:last-child').textContent = text;
            }
        }

        async function initializeApp() {
            try {
                // Check browser compatibility
                updateLoadingItem('checkBrowser', 'loading');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    updateLoadingItem('checkBrowser', 'error', 'Camera API not supported');
                    throw new Error('Browser not compatible');
                }
                updateLoadingItem('checkBrowser', 'success', 'Browser compatible');

                // Check Gun.js loading
                updateLoadingItem('checkGun', 'loading');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                if (typeof Gun === 'undefined') {
                    updateLoadingItem('checkGun', 'error', 'Failed to load Gun.js');
                    throw new Error('Gun.js not loaded');
                }
                updateLoadingItem('checkGun', 'success', 'Local database ready');

                // Initialize camera
                updateLoadingItem('checkCamera', 'loading');
                await initCamera();
                updateLoadingItem('checkCamera', 'success', 'Camera initialized');

                // Check AI server connection (quick check, don't block loading)
                updateLoadingItem('checkAI', 'loading');
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);
                    
                    const response = await fetch(`${baseURL.value}/health`, { 
                        method: 'GET',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        updateLoadingItem('checkAI', 'success', 'AI server connected');
                        showNotification('AI server ready for scanning!', 'success', 3000);
                    } else {
                        throw new Error('Server not ready');
                    }
                } catch (error) {
                    updateLoadingItem('checkAI', 'error', 'AI server offline (app still works)');
                    console.warn('AI server not available:', error);
                    showNotification('AI server offline - you can still use ASL recognition and training!', 'info', 5000);
                }

                // Check ASL Server
                updateLoadingItem('checkASL', 'loading', 'Checking ASL server...');
                try {
                    const aslAvailable = await checkAslServer();
                    if (aslAvailable) {
                        updateLoadingItem('checkASL', 'success', 'ASL server connected');
                    } else {
                        updateLoadingItem('checkASL', 'error', 'ASL server offline');
                    }
                } catch (error) {
                    updateLoadingItem('checkASL', 'error', 'ASL server offline');
                }

                // All done
                loadingText.textContent = 'ASL Command Center ready!';
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                loadingScreen.classList.add('hidden');
                checkSystemConfiguration();

            } catch (error) {
                console.error('App initialization failed:', error);
                loadingText.textContent = 'Setup completed with warnings - you can still use the app!';
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    checkSystemConfiguration();
                }, 2000);
            }
        }

        // Training Modal event listeners
        trainingBtn.addEventListener('click', showTrainingModal);
        trainingCloseBtn.addEventListener('click', hideTrainingModal);
        
        // Export and clear training data
        exportDataBtn.addEventListener('click', () => {
            exportTrainingData();
        });
        
        clearDataBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all training data?')) {
                clearTrainingData();
            }
        });
        
        // Close training modal when clicking outside
        trainingModal.addEventListener('click', (e) => {
            if (e.target === trainingModal) {
                hideTrainingModal();
            }
        });

        // Keyboard navigation for training modal
        trainingModal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideTrainingModal();
            }
        });
        
        // Training data functions
        function exportTrainingData() {
            showNotification('Exporting training data...', 'info');
            // Implementation for data export
            setTimeout(() => {
                showNotification('Training data exported successfully!', 'success');
            }, 1000);
        }
        
        function clearTrainingData() {
            showNotification('Training data cleared', 'success');
            updateTrainingStats();
        }


        // Llama chat handler
        function setupLlamaChat() {
            document.getElementById('llamaBtn').addEventListener('click', () => {
                const aiServerUrl = window.ASL_CONFIG?.AI_SERVER_URL || 'http://localhost:8080';
                window.open(aiServerUrl, '_blank');
            });
        }

        // Initialize the app
        async function initApp() {
            // Set up dynamic URLs from configuration
            if (window.ASL_CONFIG) {
                baseURL.value = window.ASL_CONFIG.AI_SERVER_URL;
                console.log('Configured AI Server URL:', window.ASL_CONFIG.AI_SERVER_URL);
                console.log('Configured ASL Server URL:', window.ASL_CONFIG.ASL_SERVER_URL);
            } else {
                console.warn('ASL_CONFIG not found, using default URLs');
                baseURL.value = 'http://localhost:8080';
            }
            
            await initCamera();
            checkSystemConfiguration();
            setupCameraRotation();
            setupLlamaChat();
            
            // Show training modal tip
            setTimeout(() => {
                showNotification('Tip: Click the Training button to view and manage ASL training data!', 'info', 5000);
            }, 2000);
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', initApp);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (intervalId) {
                clearInterval(intervalId);
            }
        });

        // Enhanced PWA installation for mobile
        let deferredPrompt;
        let installPromptShown = false;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt for mobile users
            if (!installPromptShown && isMobileDevice()) {
                showMobileInstallPrompt();
                installPromptShown = true;
            }
        });

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function showMobileInstallPrompt() {
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, var(--accent-color), #5a9fd4);
                color: white;
                padding: 15px;
                text-align: center;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideDown 0.3s ease;
            `;
            
            installBanner.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">üì± Install ASL Command Center</div>
                <div style="font-size: 0.9em; margin-bottom: 12px;">Get the full mobile experience with offline AI!</div>
                <button id="installBtn" style="
                    background: white;
                    color: var(--accent-color);
                    border: none;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-weight: 600;
                    margin-right: 10px;
                    cursor: pointer;
                ">Install App</button>
                <button id="dismissBtn" style="
                    background: transparent;
                    color: white;
                    border: 1px solid white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-weight: 600;
                    cursor: pointer;
                ">Maybe Later</button>
            `;
            
            document.body.appendChild(installBanner);
            
            // Add slide down animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideDown {
                    from { transform: translateY(-100%); }
                    to { transform: translateY(0); }
                }
            `;
            document.head.appendChild(style);
            
            // Handle install button
            document.getElementById('installBtn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            if ('setAppBadge' in navigator) {
                                // Clear any existing badge
                                navigator.clearAppBadge().catch(err => console.error('Failed to clear badge:', err));
                                
                                // Show "AI Ready" badge when model is downloaded
                                if (localStorage.getItem('model_downloaded')) {
                                    navigator.setAppBadge(1).catch(err => console.error('Failed to set badge:', err));
                                    setTimeout(() => {
                                        navigator.clearAppBadge().catch(err => console.error('Failed to clear badge:', err));
                                    }, 5000);
                                }
                            }
                            showNotification('App installed! You can now use ASL Command Center offline.', 'success', 5000);
                        }
                    deferredPrompt = null;
                }
                document.body.removeChild(installBanner);
            });
            
            // Handle dismiss button
            document.getElementById('dismissBtn').addEventListener('click', () => {
                document.body.removeChild(installBanner);
                localStorage.setItem('install_prompt_dismissed', Date.now());
            });
            
            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                if (document.body.contains(installBanner)) {
                    document.body.removeChild(installBanner);
                }
            }, 10000);
        }

        // Show install prompt again after 24 hours if dismissed
        function checkInstallPrompt() {
            const dismissed = localStorage.getItem('install_prompt_dismissed');
            if (dismissed && Date.now() - parseInt(dismissed) > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('install_prompt_dismissed');
                installPromptShown = false;
            }
        }


        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            checkInstallPrompt();
            initializeApp();
        });
    </script>
</body>
</html>